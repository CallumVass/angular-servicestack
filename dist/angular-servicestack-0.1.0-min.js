/**
 * @name: angular-servicestack
 * @description: A Service Stack client for AngularJS
 * @version: v0.1.0 - 2013-06-15
 * @link: https://github.com/kkolstad/angular-servicestack
 * @author: Kenneth Kolstad
 * @license: MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){var a;a=angular.module("angular-servicestack",[]),a.provider("serviceStackRestConfig",function(){var a;return a={urlPrefix:"/api/",maxRetries:3,maxWaitBetweenRetries:4e3,unauthorizedFn:function(){}},{setRestConfig:function(b){return a=b},$get:function(){return a}}}),a.factory("serviceStackRestClient",["serviceStackRestConfig","$http","$q","$location","$timeout","$log",function(a,b,c,d,e,f){var g,h;return h=function(){function b(a){var b;this.response=a,this.success=200<=(b=this.response.status)&&300>b,this.statusCode=this.response.status,this.success&&(this.data=this.response.data),this.success||null==this.response||null==this.response.data||(this.error=this.response.data.responseStatus),!this.success&&null!=this.response&&null!=this.response.data&&null!=this.response.data.responseStatus&&null!=this.response.data.responseStatus.errors&&this.response.data.responseStatus.errors.length>0&&(this.validationErrors=this.response.data.responseStatus.errors),this.isRetryable()&&this.incrementCollisionCount()}return b.prototype.collisionCount=function(){return null!=this.response.config&&null!=this.response.config.data?this.response.config.data._collisions||0:0},b.prototype.getConfig=function(){return this.response.config},b.prototype.hasValidationError=function(){return null!=this.validationErrors&&this.validationErrors.length>0},b.prototype.incrementCollisionCount=function(){return this.response.config.data=this.response.config.data||{},this.response.config.data._collisions=this.collisionCount()+1},b.prototype.isRetryable=function(){var b;return(500===(b=this.statusCode)||503===b?!0:void 0)&&this.collisionCount()<=a.maxRetries},b.prototype.isUnauthenticated=function(){return 401===this.statusCode},b.prototype.isUnhandledError=function(){return!this.success&&!this.isUnauthenticated()&&!this.isRetryable()},b.prototype.toLog=function(){return f.log("ServiceStackResponse:"),f.log(this),f.log("	hasValidationError: "+this.hasValidationError()),f.log("	isUnhandledError:   "+this.isUnhandledError()),f.log("	isUnauthenticated:  "+this.isUnauthenticated()),f.log("	isRetryable:        "+this.isRetryable()),f.log("	collisionCount:     "+this.collisionCount())},b}(),g=function(){function d(){}return d.prototype["delete"]=function(a,b){return null==b&&(b={}),b.method="DELETE",b.url=a,this.execute(b)},d.prototype.get=function(a,b){return null==b&&(b={}),b.method="GET",b.url=a,this.execute(b)},d.prototype.post=function(a,b,c){return null==b&&(b=null),null==c&&(c={}),c.method="POST",c.data=b,c.url=a,this.execute(c)},d.prototype.put=function(a,b,c){return null==b&&(b=null),null==c&&(c={}),c.method="PUT",c.data=b,c.url=a,this.execute(c)},d.prototype.fixUrl=function(b){var c,d;return 0===b.indexOf(a.urlPrefix)?b:(f.log("Fixing url: "+b),c=a.urlPrefix.replace(/\/+$/,""),b=b.replace(/^\/+/,""),d=""+c+"/"+b,f.log("to url: "+c+"/"+b),d)},d.prototype.execute=function(d){var f,g,i,j,k,l;return i=this,k=[],g=[],l=[],d.url=this.fixUrl(d.url),f=c.defer(),j=b(d),j.then(function(a){var b;return b=new h(a),f.resolve(b)},function(a){var b;return b=new h(a),f.reject(b)}),f.promise.success=function(a){return k.push(a),f.promise.then(function(b){return a(b)}),f.promise},f.promise.error=function(a){return g.push(a),f.promise.then(null,function(b){return b.isUnhandledError()&&!b.hasValidationError()?a(b):void 0}),f.promise},f.promise.validation=function(a){return l.push(a),f.promise.then(null,function(b){return b.isUnhandledError()&&b.hasValidationError()?a(b):void 0}),f.promise},f.promise.then(null,function(b){if(b.isUnauthenticated()){if(null!=a.unauthorizedFn&&angular.isFunction(a.unauthorizedFn))return a.unauthorizedFn();if(null!=g&&angular.isFunction(g))return g(b)}}),f.promise.then(null,function(b){var c;return b.isRetryable()?(c=Math.min(Math.random()*100*Math.pow(4,b.collisionCount()-1),a.maxWaitBetweenRetries),e(function(){var a,c,d,e,f,h,j,m;for(c=i.execute(b.getConfig()),d=0,h=k.length;h>d;d++)a=k[d],c.success(a);for(e=0,j=g.length;j>e;e++)a=g[e],c.error(a);for(f=0,m=l.length;m>f;f++)a=l[f],c.validation(a);return c},c)):void 0}),f.promise},d}(),new g}])}.call(this);